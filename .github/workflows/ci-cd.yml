name: Confero CI/CD

on:
  push:
    branches:
      - main
      - sameer
  pull_request:
    branches:
      - main

jobs:
  ci:
    name: CI (Lint & Backend Build)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Enable pnpm
        run: |
          corepack enable
          corepack prepare pnpm@10.26.2 --activate

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm lint

      - name: Build backend only
        run: pnpm --filter backend build

      - name: Prepare backend artifact
        run: |
          rm -rf backend-prod
          mkdir backend-prod
          cp -r backend/dist backend-prod/
          cp backend/package.json backend-prod/

      - name: Upload backend artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-prod
          path: backend-prod

  cd:
  name: CD (Deploy Backend to EC2)
  needs: ci
  if: github.ref == 'refs/heads/main'
  runs-on: ubuntu-latest

  steps:
    - name: Download backend artifact
      uses: actions/download-artifact@v4
      with:
        name: backend-prod
        path: backend-prod

    - name: Debug â€“ verify artifact
      run: |
        pwd
        ls -la
        echo "---- backend-prod ----"
        ls -la backend-prod

    - name: Upload backend to EC2
      uses: appleboy/scp-action@v0.1.7
      with:
        debug: true
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_KEY }}
        source: 'backend-prod'
        target: '/var/www/confero'

    - name: Restart backend on EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_KEY }}
        script: |
          cd /var/www/confero/backend-prod
          npm install --omit=dev
          pm2 reload confero-backend || pm2 start dist/index.js --name confero-backend
          pm2 save
